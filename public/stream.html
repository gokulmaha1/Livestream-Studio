<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, height=1080, initial-scale=1.0">
    <title>Stream Compositor</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; width: 1920px; height: 1080px; }
        #bgVideo {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1;
        }
        #overlayContainer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none;
        }
    </style>
</head>
<body>
    <video id="bgVideo" loop autoplay muted>
        <source src="/assets/background.mp4" type="video/mp4">
    </video>
    <div id="overlayContainer"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const container = document.getElementById('overlayContainer');
        const video = document.getElementById('bgVideo');

        // Force 1080p
        window.resizeTo(1920, 1080);

        // Load active overlay
        async function loadOverlay() {
            try {
                const res = await fetch('/api/overlays');
                const data = await res.json();
                if (data.overlays.length > 0) {
                    // Use the most recently updated overlay
                    const overlay = data.overlays.sort((a,b) => b.updatedAt - a.updatedAt)[0];
                    renderOverlay(overlay);
                }
            } catch (e) { console.error("Failed to load overlay", e); }
        }

        function renderOverlay(overlay) {
            if (!overlay) return;
            // Create shadow DOM for isolation or just generic styles
            const style = document.createElement('style');
            style.id = 'overlayStyles';
            style.textContent = overlay.css;
            
            const content = document.createElement('div');
            content.id = 'overlayContent';
            content.innerHTML = overlay.html;

            // Execute JS safely-ish
            try {
                const script = document.createElement('script');
                script.textContent = overlay.js;
                document.body.appendChild(script);
            } catch(e) {}

            container.innerHTML = '';
            document.head.appendChild(style);
            container.appendChild(content);
        }

        socket.on('overlay-updated', (overlay) => {
            renderOverlay(overlay);
        });

        // Ensure video plays
        video.play().catch(e => console.log("Autoplay blocked/failed", e));

        loadOverlay();
    </script>
</body>
</html>
